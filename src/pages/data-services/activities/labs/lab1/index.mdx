---
title: Postgress cloud Lab
---

## Activity description

In this excercise, you will configure an application to write data to a PostgreSQL database running in the IBM Cloud. This activity will use three items created on the IBM Cloud.

1. An instance of a postgress database
1. The IBM image registry
1. An IBM Kubernetes cluster (also known as IKS)

**Note:** This lab is based on code from [https://github.com/IBM-Cloud/clouddatabases-helloworld-kubernetes-examples](https://github.com/IBM-Cloud/clouddatabases-helloworld-kubernetes-examples) We are using the pode from the 

## Prerequisites

See the [Prerequisites section](/prerequisites) for the prerequisites for this lab.

## Information required to complete this lab

Write down each of these before you begin this exercise. You must know these values to complete this lab.
1. Kubernetes cluster name: <br/>[cluster_name]<hr/>
1. Postgres database name: <br/>[database_name]<hr/>
1. Kubernetes secret to access the database: <br/>[path-to-secret_name]<hr/>

## Activity

### Add the IBM Cloud Databases for PostgreSQL service to your cluster 

**Note:** If your database uses both public and private endpoints, your public endpoint will be used by default. Therefore, if you want to select the private endpoint, first you will need to create a service key for your database so Kubernetes can use it when binding to the database.

For this lab the key has been created. You'll bind the database to the Kubernetes cluster by applying a yaml file:

```
kubectl apply -f postgress-secret.yaml
```

This will create a secret in your Kubernetes cluster using the database's private endpoint from the key you've created above.

Verify that the Kubernetes secret was created in your cluster namespace. Kubernetes uses secrets to store confidential information like the IBM Cloud Identity and Access Management (IAM) API key and the URL that the container uses to gain access. Running the following command, you'll get the API key for accessing the instance of your Databases for PostgreSQL service that's provisioned in your account.

```
kubectl get secrets --namespace=default
```

Clone the app to your local environment from your terminal using the following command:

```
git clone -b node git@github.com:IBM-Cloud/clouddatabases-helloworld-kubernetes-examples.git
```

`cd` into this newly created directory `clouddatabases-helloworld-kubernetes-examples`, and `cd` into the `postgresql` folder. The code for connecting to the service, and reading from and updating the database can be found in server.js. See Code Structure and the code comments for information on the app's functions. There's also a public directory, which contains the html, style sheets and JavaScript for the web app. But, to get the application working, we'll first need to push the Docker image of this application to our IBM Cloud Container Registry.

Build and push the application's Docker image to your IBM Cloud Container Registry. We're calling this container icdpg. **Note:** There is a period (dot) at the end of the following command.

```
ibmcloud cr build -t icr.io/[your_namespace]/icdpg .
```

After it's built, you can view the image in container registry using:

```
ibmcloud cr images
```

You'll get something like the following response:
```
REPOSITORY                       TAG      DIGEST         NAMESPACE   CREATED       SIZE    SECURITY STATUS
icr.io/[namespace]/icdpg         latest   81c3959ea657   [namespace] 4 hours ago   28 MB   No Issues
```

Update the Kubernetes deployment configuration file clouddb-deployment.yaml see below:
```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: icdpostgres-app
spec:
  replicas: 1
  selector:
    matchLabels:
      run: clouddb-demo
  template:
    metadata:
      name: icdpostgres-app
      labels:
        run: clouddb-demo
    spec:
      containers:
      - name: cloudpostgres-nodejs-app
        image: "us.icr.io/[namespace]/icdpg" # Edit me
        imagePullPolicy: Always
        env:
        - name: BINDING
          valueFrom:
            secretKeyRef:
              name: binding-postgressql-cloudnative-bootcamp
              key: binding
---
apiVersion: v1
kind: Service
metadata:
  name: cloudpostgres-service
  labels:
    run: clouddb-demo
spec:
  type: NodePort
  selector:
    run: clouddb-demo
  ports:
  - protocol: TCP
    port: 8080
    nodePort: 30081
```

Change the image name to have the namespace that you used in a previous step:
```
image: "icr.io/[namespace]/icdpg" # Edit me
```

Under `secretKeyRef` section, notice the name `binding-postgressql-cloudnative-bootcamp` this matches the name of the secret that was generated for the IBM Cloud Databases for PostgreSQL This secret was provided to you in the `postgress-secret.yaml` file.

```
secretKeyRef:
  name: binding-postgressql-cloudnative-bootcamp 
```

As for the service configuration at the bottom of the file, nodePort indicates the port that the application can be accessed from. You have a range from 30000 - 32767 that you can use, but we've chosen 30081. As for the TCP port, it's set to 8080, which is the port that the Node.js application runs on in the container. 


Deploy the application to IBM Cloud Kubernetes Service. When you deploy the application, it will automatically be bound to your Kubernetes cluster.

```
kubectl apply -f clouddb-deployment.yaml
```

Check on the pod that was created:
```
kubectl get pods

kubectl describe pod icdpostgres-app-[your-pod]


```

Get the IP for the application.

```
ibmcloud ks workers [cluster_name]
```

The result will be something like:

```
ID                                                       Public IP        Private IP      Flavor               State    Status   Zone    Version
kube-brhugogd0clno4mkrdq0-iksbootcamp-default-000001c6   169.62.243.241   10.186.26.80    b3c.4x16.encrypted   normal   Ready    dal13   1.17.6_1527*
```

Now you can access the application from the Public IP with a port of 30081. From your browser, go to: `http://[Cluster_Public_IP]:30081`

The clouddatabases-postgresql-helloworld app displays the contents of an examples database. To demonstrate that the app is connected to your service, add some words to the database. The words are displayed as you add them, with the most recently added words displayed first.

![Postgress App](./images/postgressApp.png)

## Code Structure

### File	Description

- server.js	Establishes a connection to the PostgreSQL database using credentials from BINDING (the name we created in the Kubernetes deployment file to expose the PostgreSQL credentials) and handles create and read operations on the database.
- main.js	Handles user input for a PUT command and parses the results of a GET command to output the contents of the PostgreSQL database.

## REST - The app uses a PUT and a GET operation:

- PUT

-- takes user input from main.js
-- uses the client.query method to add the user input to the words table
- GET

-- uses client.query method to retrieve the contents of the words table
-- returns the response of the database command to main.js
