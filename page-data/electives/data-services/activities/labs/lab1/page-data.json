{"componentChunkName":"component---src-pages-electives-data-services-activities-labs-lab-1-index-mdx","path":"/electives/data-services/activities/labs/lab1/","result":{"pageContext":{"frontmatter":{"title":"Postgress cloud Lab"},"relativePagePath":"/electives/data-services/activities/labs/lab1/index.mdx","titleType":"page","MdxNode":{"id":"570ae787-bbfd-5034-aa94-3c3c349b9d64","children":[],"parent":"331d7bef-a607-56fd-a9a8-c6bd6eb16672","internal":{"content":"---\ntitle: Postgress cloud Lab\n---\n\n## Activity description\n\nIn this excercise, you will configure an application to write data to a PostgreSQL database running in the IBM Cloud. This activity will use the following items:\n\n1. An instance of a postgress database\n1. A Kubernetes cluster\n\n### Extra credit\n\nIn the extra credit part of this excercise, you will build an image for the application, push it to the IBM Container Registry, and define your yaml so it pulls the image from the IBM Container Registry. For this activity you will also need:\n\n1. An IBM Cloud login\n1. The resource group for your access to the IBM Container Registry\n1. Access to the IBM Container Registry\n\n**Note:** This lab is based on code from [https://github.com/IBM-Cloud/clouddatabases-helloworld-kubernetes-examples](https://github.com/IBM-Cloud/clouddatabases-helloworld-kubernetes-examples) We are using the code from the [postgres section.](https://github.com/IBM-Cloud/clouddatabases-helloworld-kubernetes-examples/tree/node/postgresql)\n\n## Prerequisites\n\nSee the [Prerequisites section](/prerequisites) for the prerequisites for this lab.\n\n## Information required to complete this lab\n\nWrite down each of these before you begin this exercise. You must know these values to complete this lab.\n1. Kubernetes cluster name: <br/>[cluster_name]<hr/>\n1. Postgres database name: <br/>[database_name]<hr/>\n1. Kubernetes secret to access the database: <br/>[path-to-secret_name]<hr/>\n\n## Activity\n\n### Add the Kubernetes secret to your cluster \n\n**Note:** If your database uses both public and private endpoints, your public endpoint will be used by default. Therefore, if you want to select the private endpoint, first you will need to create a service key for your database so Kubernetes can use it when binding to the database.\n\nFor this lab the key has been created. **Note:** You should download the `postgress-secret.yaml` file to the current directory. You'll bind the database to the Kubernetes cluster by applying a yaml file. Apply the secrets yaml file with the command:\n\n```\nkubectl apply -f postgress-secret.yaml\n```\n\nThis will create a secret in your Kubernetes cluster using the database's private endpoint from the key you've created above.\n\nVerify that the Kubernetes secret was created in your cluster namespace. Kubernetes uses secrets to store confidential information like the IBM Cloud Identity and Access Management (IAM) API key and the URL that the container uses to gain access. Running the following command, you'll get the API key for accessing the instance of your Databases for PostgreSQL service that's provisioned in your account.\n\n```\nkubectl get secrets\n```\n### Create a yaml file to deploy the application\n\nTake a look at the yaml file below. Save this file as `clouddb-deployment.yaml`\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: icdpostgres-app\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      run: clouddb-demo\n  template:\n    metadata:\n      name: icdpostgres-app\n      labels:\n        run: clouddb-demo\n    spec:\n      containers:\n        - name: cloudpostgres-nodejs-app\n          image: docker.io/ibmcase/icdpg:1.0\n          imagePullPolicy: Always\n          env:\n            - name: BINDING\n              valueFrom:\n                secretKeyRef:\n                  name: binding-postgressql-cloudnative-bootcamp\n                  key: binding\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: cloudpostgres-service\n  labels:\n    run: clouddb-demo\nspec:\n  type: NodePort\n  selector:\n    run: clouddb-demo\n  ports:\n    - protocol: TCP\n      port: 8080\n```\n### Examine the yaml file\n\nYou should notice several things in this yaml file.\n\nThe image is pulled from [docker hub](https://hub.docker.com/repository/docker/ibmcase/icdpg) Notice the `spec` section contains the name of the image:\n\n```\n    spec:\n      containers:\n      - name: cloudpostgres-nodejs-app\n        image: docker.io/ibmcase/icdpg:1.0 \n```\n\n\nUnder `secretKeyRef` section, notice the name `binding-postgressql-cloudnative-bootcamp` this matches the name of the secret that was generated for the IBM Cloud Databases for PostgreSQL This secret was provided to you in the `postgress-secret.yaml` file.\n\n```\nsecretKeyRef:\n  name: binding-postgressql-cloudnative-bootcamp \n```\n\n\n### Apply the yaml file\n\nDeploy the application to your Kubernetes cluster. When you deploy the application, it will automatically be bound to your Kubernetes cluster.\n\n```\nkubectl apply -f clouddb-deployment.yaml\n```\n\nDescribe the deployment\n```\nkubectl describe deployment icdpostgres-app\n```\n\nCheck on the pod that was created:\n```\nkubectl get pod -l run=clouddb-demo\n```\n\nGet the URL for the application. Use the code below to get the URL for the apllication:\n\n```\nkubectl port-forward service/cloudpostgres-service 8080:8080\n```\n\nTry the URL from your browser on http://localhost:8080\n\n\nThe clouddatabases-postgresql-helloworld app displays the contents of an examples database. To demonstrate that the app is connected to your service, add some words to the database. The words are displayed as you add them, with the most recently added words displayed first.\n\n![Postgress App](./images/postgressApp.png)\n\n\n## Extra credit\n\nIn this section you will use the IBM Cloud Registry to store the image. You will build the image but you do not need Docker Desktop. The build will happen on the IBM Cloud.\n\n### Login in to the IBM Cloud from the command line\n\nConnect to IBM Cloud in the command line tool and follow the prompts to log in.\n\n```\nibmcloud login\n```\n\n**Note:** If you have a federated user ID, use the `ibmcloud login --sso` command to log in with your single sign on ID.\n\nMake sure you are targeting the correct IBM Cloud resource group of your IBM Cloud Kubernetes Service.\n\nUse the following command to target your cluster resource group if your resource group is other than default.\n\n```\nibmcloud target -g [resource_group_name]\n```\n\n### Create a namespace to store your image\n\nCreate your own private image repository in IBM Cloud Container Registry to store your application's Docker image. Since we want the images to be private, we need to create a namespace, which will create a unique URL to your image repository. **Note:** Use your initials to make the namespace unique and easier to find.\n\nYou can create a namespace with the command: \n\n```\nibmcloud cr namespace-add [your-initials]-cloud-native\n```\n\nYou can see a list of all namespaces with:\n\n```\nibmcloud cr namespaces\n```\n\nClone the app to your local environment from your terminal using the following command:\n\n```\ngit clone -b node https://github.com/IBM-Cloud/clouddatabases-helloworld-kubernetes-examples.git\ncd clouddatabases-helloworld-kubernetes-examples/postgresql\n```\n\n`cd` into this newly created directory `clouddatabases-helloworld-kubernetes-examples`, and `cd` into the `postgresql` folder. The code for connecting to the service, and reading from and updating the database can be found in server.js. See Code Structure and the code comments for information on the app's functions. There's also a public directory, which contains the html, style sheets and JavaScript for the web app. But, to get the application working, we'll first need to push the Docker image of this application to our IBM Cloud Container Registry.\n\nBuild and push the application's Docker image to your IBM Cloud Container Registry. We're calling this container icdpg. **Note:** There is a period (dot) at the end of the following command.\n\nCheck the region where you registry is located in our example we use `us-south` and the registry hostname is `us.icr.io`\n\n```\nibmcloud cr build -t us.icr.io/[your_namespace]/icdpg .\n```\n\nAfter it's built, you can view the image in container registry using:\n\n```\nibmcloud cr images\n```\n\nYou'll get something like the following response:\n```\nREPOSITORY                       TAG      DIGEST         NAMESPACE   CREATED       SIZE    SECURITY STATUS\nus.icr.io/[namespace]/icdpg         latest   81c3959ea657   [namespace] 4 hours ago   28 MB   No Issues\n```\n\n\n## Code Structure\n\n### File\tDescription\n\n- server.js\tEstablishes a connection to the PostgreSQL database using credentials from BINDING (the name we created in the Kubernetes deployment file to expose the PostgreSQL credentials) and handles create and read operations on the database.\n- main.js\tHandles user input for a PUT command and parses the results of a GET command to output the contents of the PostgreSQL database.\n\n## REST - The app uses a PUT and a GET operation:\n\n- PUT\n\n-- takes user input from main.js\n-- uses the client.query method to add the user input to the words table\n- GET\n\n-- uses client.query method to retrieve the contents of the words table\n-- returns the response of the database command to main.js\n","type":"Mdx","contentDigest":"a23d0406c447cd6156e2906f44934615","owner":"gatsby-plugin-mdx","counter":573},"frontmatter":{"title":"Postgress cloud Lab"},"exports":{},"rawBody":"---\ntitle: Postgress cloud Lab\n---\n\n## Activity description\n\nIn this excercise, you will configure an application to write data to a PostgreSQL database running in the IBM Cloud. This activity will use the following items:\n\n1. An instance of a postgress database\n1. A Kubernetes cluster\n\n### Extra credit\n\nIn the extra credit part of this excercise, you will build an image for the application, push it to the IBM Container Registry, and define your yaml so it pulls the image from the IBM Container Registry. For this activity you will also need:\n\n1. An IBM Cloud login\n1. The resource group for your access to the IBM Container Registry\n1. Access to the IBM Container Registry\n\n**Note:** This lab is based on code from [https://github.com/IBM-Cloud/clouddatabases-helloworld-kubernetes-examples](https://github.com/IBM-Cloud/clouddatabases-helloworld-kubernetes-examples) We are using the code from the [postgres section.](https://github.com/IBM-Cloud/clouddatabases-helloworld-kubernetes-examples/tree/node/postgresql)\n\n## Prerequisites\n\nSee the [Prerequisites section](/prerequisites) for the prerequisites for this lab.\n\n## Information required to complete this lab\n\nWrite down each of these before you begin this exercise. You must know these values to complete this lab.\n1. Kubernetes cluster name: <br/>[cluster_name]<hr/>\n1. Postgres database name: <br/>[database_name]<hr/>\n1. Kubernetes secret to access the database: <br/>[path-to-secret_name]<hr/>\n\n## Activity\n\n### Add the Kubernetes secret to your cluster \n\n**Note:** If your database uses both public and private endpoints, your public endpoint will be used by default. Therefore, if you want to select the private endpoint, first you will need to create a service key for your database so Kubernetes can use it when binding to the database.\n\nFor this lab the key has been created. **Note:** You should download the `postgress-secret.yaml` file to the current directory. You'll bind the database to the Kubernetes cluster by applying a yaml file. Apply the secrets yaml file with the command:\n\n```\nkubectl apply -f postgress-secret.yaml\n```\n\nThis will create a secret in your Kubernetes cluster using the database's private endpoint from the key you've created above.\n\nVerify that the Kubernetes secret was created in your cluster namespace. Kubernetes uses secrets to store confidential information like the IBM Cloud Identity and Access Management (IAM) API key and the URL that the container uses to gain access. Running the following command, you'll get the API key for accessing the instance of your Databases for PostgreSQL service that's provisioned in your account.\n\n```\nkubectl get secrets\n```\n### Create a yaml file to deploy the application\n\nTake a look at the yaml file below. Save this file as `clouddb-deployment.yaml`\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: icdpostgres-app\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      run: clouddb-demo\n  template:\n    metadata:\n      name: icdpostgres-app\n      labels:\n        run: clouddb-demo\n    spec:\n      containers:\n        - name: cloudpostgres-nodejs-app\n          image: docker.io/ibmcase/icdpg:1.0\n          imagePullPolicy: Always\n          env:\n            - name: BINDING\n              valueFrom:\n                secretKeyRef:\n                  name: binding-postgressql-cloudnative-bootcamp\n                  key: binding\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: cloudpostgres-service\n  labels:\n    run: clouddb-demo\nspec:\n  type: NodePort\n  selector:\n    run: clouddb-demo\n  ports:\n    - protocol: TCP\n      port: 8080\n```\n### Examine the yaml file\n\nYou should notice several things in this yaml file.\n\nThe image is pulled from [docker hub](https://hub.docker.com/repository/docker/ibmcase/icdpg) Notice the `spec` section contains the name of the image:\n\n```\n    spec:\n      containers:\n      - name: cloudpostgres-nodejs-app\n        image: docker.io/ibmcase/icdpg:1.0 \n```\n\n\nUnder `secretKeyRef` section, notice the name `binding-postgressql-cloudnative-bootcamp` this matches the name of the secret that was generated for the IBM Cloud Databases for PostgreSQL This secret was provided to you in the `postgress-secret.yaml` file.\n\n```\nsecretKeyRef:\n  name: binding-postgressql-cloudnative-bootcamp \n```\n\n\n### Apply the yaml file\n\nDeploy the application to your Kubernetes cluster. When you deploy the application, it will automatically be bound to your Kubernetes cluster.\n\n```\nkubectl apply -f clouddb-deployment.yaml\n```\n\nDescribe the deployment\n```\nkubectl describe deployment icdpostgres-app\n```\n\nCheck on the pod that was created:\n```\nkubectl get pod -l run=clouddb-demo\n```\n\nGet the URL for the application. Use the code below to get the URL for the apllication:\n\n```\nkubectl port-forward service/cloudpostgres-service 8080:8080\n```\n\nTry the URL from your browser on http://localhost:8080\n\n\nThe clouddatabases-postgresql-helloworld app displays the contents of an examples database. To demonstrate that the app is connected to your service, add some words to the database. The words are displayed as you add them, with the most recently added words displayed first.\n\n![Postgress App](./images/postgressApp.png)\n\n\n## Extra credit\n\nIn this section you will use the IBM Cloud Registry to store the image. You will build the image but you do not need Docker Desktop. The build will happen on the IBM Cloud.\n\n### Login in to the IBM Cloud from the command line\n\nConnect to IBM Cloud in the command line tool and follow the prompts to log in.\n\n```\nibmcloud login\n```\n\n**Note:** If you have a federated user ID, use the `ibmcloud login --sso` command to log in with your single sign on ID.\n\nMake sure you are targeting the correct IBM Cloud resource group of your IBM Cloud Kubernetes Service.\n\nUse the following command to target your cluster resource group if your resource group is other than default.\n\n```\nibmcloud target -g [resource_group_name]\n```\n\n### Create a namespace to store your image\n\nCreate your own private image repository in IBM Cloud Container Registry to store your application's Docker image. Since we want the images to be private, we need to create a namespace, which will create a unique URL to your image repository. **Note:** Use your initials to make the namespace unique and easier to find.\n\nYou can create a namespace with the command: \n\n```\nibmcloud cr namespace-add [your-initials]-cloud-native\n```\n\nYou can see a list of all namespaces with:\n\n```\nibmcloud cr namespaces\n```\n\nClone the app to your local environment from your terminal using the following command:\n\n```\ngit clone -b node https://github.com/IBM-Cloud/clouddatabases-helloworld-kubernetes-examples.git\ncd clouddatabases-helloworld-kubernetes-examples/postgresql\n```\n\n`cd` into this newly created directory `clouddatabases-helloworld-kubernetes-examples`, and `cd` into the `postgresql` folder. The code for connecting to the service, and reading from and updating the database can be found in server.js. See Code Structure and the code comments for information on the app's functions. There's also a public directory, which contains the html, style sheets and JavaScript for the web app. But, to get the application working, we'll first need to push the Docker image of this application to our IBM Cloud Container Registry.\n\nBuild and push the application's Docker image to your IBM Cloud Container Registry. We're calling this container icdpg. **Note:** There is a period (dot) at the end of the following command.\n\nCheck the region where you registry is located in our example we use `us-south` and the registry hostname is `us.icr.io`\n\n```\nibmcloud cr build -t us.icr.io/[your_namespace]/icdpg .\n```\n\nAfter it's built, you can view the image in container registry using:\n\n```\nibmcloud cr images\n```\n\nYou'll get something like the following response:\n```\nREPOSITORY                       TAG      DIGEST         NAMESPACE   CREATED       SIZE    SECURITY STATUS\nus.icr.io/[namespace]/icdpg         latest   81c3959ea657   [namespace] 4 hours ago   28 MB   No Issues\n```\n\n\n## Code Structure\n\n### File\tDescription\n\n- server.js\tEstablishes a connection to the PostgreSQL database using credentials from BINDING (the name we created in the Kubernetes deployment file to expose the PostgreSQL credentials) and handles create and read operations on the database.\n- main.js\tHandles user input for a PUT command and parses the results of a GET command to output the contents of the PostgreSQL database.\n\n## REST - The app uses a PUT and a GET operation:\n\n- PUT\n\n-- takes user input from main.js\n-- uses the client.query method to add the user input to the words table\n- GET\n\n-- uses client.query method to retrieve the contents of the words table\n-- returns the response of the database command to main.js\n","fileAbsolutePath":"/home/runner/work/learning-cloudnative-101/learning-cloudnative-101/src/pages/electives/data-services/activities/labs/lab1/index.mdx"}}},"staticQueryHashes":["1364590287","137577622","137577622","2102389209","2102389209","2456312558","2746626797","2746626797","3037994772","3037994772","530240012","530240012","768070550"]}